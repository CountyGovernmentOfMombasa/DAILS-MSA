      - name: Deploy to Ubuntu Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 4792
          script: |
            echo "=== Starting Deployment ==="
            cd /var/www/dial-msa

            echo "Pulling latest code..."
            git fetch --all
            git reset --hard origin/main

            echo "Installing backend dependencies..."
            cd backend
            npm ci --omit=dev

            echo "Building frontend..."
            cd /var/www/dial-msa/my-app
            npm ci
            npm run build

            echo "Restarting PM2 app..."
            cd ../backend

            # Ensure PM2 is installed and available
            if ! command -v pm2 &> /dev/null
            then
              echo "PM2 not found. Installing..."
              sudo npm install -g pm2
            fi

            # Ensure PM2 environment is linked to current Node version
            pm2 resurrect || true
            pm2 start app.js --name dials-msa || pm2 restart dials-msa --update-env
            pm2 save
            pm2 list

            echo "=== Deployment Complete ==="
