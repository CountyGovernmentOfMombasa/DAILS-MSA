name: ğŸš€ Deploy Node + React App to Ubuntu VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 4792
          script: |
            echo "=== ğŸš€ Starting Deployment on $(hostname) ==="

            # Go to the project directory
            cd /var/www/dial-msa || exit 1

            echo "ğŸ”§ Configuring git remote to use SSH..."
            # The GITHUB_REPOSITORY variable is in the format "owner/repo"
            git remote set-url origin git@github.com:${GITHUB_REPOSITORY}.git

            echo "ï¿½ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ§° Installing backend dependencies..."
            cd backend
            npm ci --omit=dev

            echo "ğŸ§± Building frontend..."
            cd /var/www/dial-msa/my-app
            npm ci
            npm run build

            echo "ğŸ§¹ Cleaning old frontend build (if served by backend)..."
            rm -rf /var/www/dial-msa/backend/public
            mkdir -p /var/www/dial-msa/backend/public
            cp -r build/* /var/www/dial-msa/backend/public/

            echo "âš™ï¸ Ensuring PM2 is installed..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            echo "ğŸ”„ Ensuring PM2 startup service is enabled..."
            # This command generates a startup script. We run it and then save the current process list.
            # The `|| true` prevents the workflow from failing if the service is already set up.
            sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${{ secrets.SSH_USER }} --hp /home/${{ secrets.SSH_USER }} || true

            echo "ğŸš€ Restarting PM2 process..."
            cd /var/www/dial-msa/backend

            # Restart or start the app under PM2
            if pm2 describe dials-msa &> /dev/null; then
              pm2 restart dials-msa --update-env
            else
              pm2 start app.js --name dials-msa
            fi

            pm2 save
            pm2 list

            echo "âœ… Deployment complete at $(date)"
