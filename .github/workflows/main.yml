name: ðŸš€ Deploy Node + React App to Ubuntu VM

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            my-app/package-lock.json

      - name: ðŸ“¦ Install backend dependencies
        run: npm ci --prefix backend --omit=dev

      - name: ðŸ“¦ Install and build frontend
        run: |
          npm ci --prefix my-app
          npm run build --prefix my-app

      - name: ðŸ§¹ Prepare deployment artifact
        run: |
          mkdir -p deploy/backend/public
          cp -r my-app/build/* deploy/backend/public/
          cp -r backend/node_modules deploy/backend/node_modules
          cp backend/app.js deploy/backend/app.js
          cp backend/package.json deploy/backend/package.json
          cp backend/package-lock.json deploy/backend/package-lock.json
          cd deploy
          tar -czf ../build.tar.gz .

      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 4792
          # Use 'script_stop: true' to continue on non-zero exit codes if needed
          script: |
            echo "=== ðŸš€ Starting Deployment on $(hostname) ==="
            set -e # Exit immediately if a command exits with a non-zero status.

            APP_DIR="/var/www/dial-msa"
            PM2_APP_NAME="dials-msa"

            echo "ðŸ“‚ Creating project directory..."
            mkdir -p $APP_DIR

            echo "ðŸ›‘ Stopping PM2 process..."
            pm2 stop $PM2_APP_NAME || true

            echo "ðŸ§¹ Cleaning old application files..."
            rm -rf $APP_DIR/*

      - name: ðŸšš Copy artifact to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 4792
          source: "build.tar.gz"
          target: "/var/www/dial-msa"

      - name: ðŸš€ Extract and Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 4792
          script: |
            echo "=== ðŸš€ Finalizing Deployment on $(hostname) ==="
            set -e

            APP_DIR="/var/www/dial-msa"
            PM2_APP_NAME="dials-msa"

            echo "ðŸ”§ Configuring git remote to use SSH..."
            # The GITHUB_REPOSITORY variable is in the format "owner/repo"
            git remote set-url origin git@github.com:${GITHUB_REPOSITORY}.git

            echo "ðŸ”‘ Adding GitHub's SSH key to known_hosts..."
            # Create .ssh directory if it doesn't exist
            mkdir -p ~/.ssh && ssh-keyscan github.com >> ~/.ssh/known_hosts

            echo "ï¿½ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            cd $APP_DIR
            echo "ðŸ“¦ Extracting build artifact..."
            tar -xzf build.tar.gz
            rm build.tar.gz

            echo "ðŸš€ Starting/Restarting PM2 process..."
            cd $APP_DIR/backend

            echo "ðŸ§± Building frontend..."
            cd /var/www/dial-msa/my-app
            npm ci
            npm run build

            echo "ðŸ§¹ Cleaning old frontend build (if served by backend)..."
            rm -rf /var/www/dial-msa/backend/public
            mkdir -p /var/www/dial-msa/backend/public
            cp -r build/* /var/www/dial-msa/backend/public/

            echo "âš™ï¸ Ensuring PM2 is installed..."
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            echo "ðŸ”„ Ensuring PM2 startup service is enabled..."
            # This command generates a startup script. We run it and then save the current process list.
            # The `|| true` prevents the workflow from failing if the service is already set up.
            sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u ${{ secrets.SSH_USER }} --hp /home/${{ secrets.SSH_USER }} || true

            echo "ðŸš€ Restarting PM2 process..."
            cd /var/www/dial-msa/backend

            # Restart or start the app under PM2
            if pm2 describe dials-msa &> /dev/null; then
              pm2 restart dials-msa --update-env
            # Start or restart the app under PM2
            if pm2 describe $PM2_APP_NAME &> /dev/null; then
              pm2 restart $PM2_APP_NAME --update-env
            else
              pm2 start app.js --name $PM2_APP_NAME
            fi

            pm2 save
            pm2 list

            echo "âœ… Deployment complete at $(date)"
